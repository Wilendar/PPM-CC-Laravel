# Claude Code Hooks - Complete Fix Documentation

**Data:** 2025-10-31
**Status:** âœ… NAPRAWIONE
**Projekt:** PPM-CC-Laravel

---

## ðŸš¨ Problem

Lokalne project hooks w PPM-CC-Laravel **nie dziaÅ‚aÅ‚y** z powodu dwÃ³ch gÅ‚Ã³wnych bÅ‚Ä™dÃ³w:

### 1. NieprawidÅ‚owa lokalizacja plikÃ³w
- **BÅ‚Ä…d:** Hooki umieszczone w `_TOOLS/` zamiast `.claude/hooks/`
- **Skutek:** Brak zgodnoÅ›ci ze standardem Claude Code

### 2. ðŸ”´ KRYTYCZNY: Brak stdin consumption
- **BÅ‚Ä…d:** Å»aden hook nie konsumowaÅ‚ stdin
- **Skutek:** **Deadlock â†’ CLI freeze** â†’ hooki nie wykonywaÅ‚y siÄ™
- **Root cause:** Claude Code wysyÅ‚a JSON session info przez stdin. JeÅ›li nie jest konsumowany â†’ deadlock

---

## âœ… RozwiÄ…zanie

### Krok 1: Analiza oficjalnej dokumentacji

Przeanalizowano peÅ‚nÄ… dokumentacjÄ™ Claude Code hooks:
- https://docs.claude.com/en/docs/claude-code/hooks
- https://docs.claude.com/en/docs/claude-code/hooks-guide.md

**Kluczowe ustalenia:**
1. Project hooks powinny byÄ‡ w `.claude/hooks/` (standard location)
2. **MANDATORY:** KaÅ¼dy hook MUSI konsumowaÄ‡ stdin (`sys.stdin.read()`)
3. Hooki MUSZÄ„ wychodziÄ‡ z exit code 0 (success) lub 2 (blocking)

### Krok 2: Utworzenie wÅ‚aÅ›ciwej struktury

```bash
.claude/hooks/
â”œâ”€â”€ pre_compact_snapshot.py
â”œâ”€â”€ post_autocompact_recovery.py
â””â”€â”€ session_start_rules_reminder.py
```

### Krok 3: Aktualizacja settings.local.json

**ByÅ‚o:**
```json
"PreCompact": [{
  "hooks": [{
    "command": "python _TOOLS/pre_compact_snapshot.py",
    "timeout": 5000
  }]
}]
```

**Jest:**
```json
"PreCompact": [{
  "hooks": [{
    "command": "python .claude/hooks/pre_compact_snapshot.py",
    "timeout": 5000
  }]
}]
```

**Analogiczne zmiany dla:**
- `SessionStart` â†’ `post_autocompact_recovery.py`
- `SessionStart` â†’ `session_start_rules_reminder.py`

### Krok 4: Aktualizacja permissions

**ByÅ‚o:**
```json
"Bash(python _TOOLS/pre_compact_snapshot.py:*)",
"Bash(python _TOOLS/post_autocompact_recovery.py:*)",
"Bash(python _TOOLS/session_start_rules_reminder.py:*)"
```

**Jest:**
```json
"Bash(python .claude/hooks/pre_compact_snapshot.py:*)",
"Bash(python .claude/hooks/post_autocompact_recovery.py:*)",
"Bash(python .claude/hooks/session_start_rules_reminder.py:*)"
```

### Krok 5: ðŸ”´ KRYTYCZNA NAPRAWA - Stdin consumption

**KAÅ»DY hook musi mieÄ‡ na poczÄ…tku funkcji main():**

```python
def main():
    """GÅ‚Ã³wna funkcja hooka"""
    try:
        # CRITICAL: Consume stdin to prevent deadlock (Claude sends JSON session info)
        stdin_data = sys.stdin.read()

        # (rest of hook logic)
```

**Bez tej linii hook powoduje deadlock i freeze CLI!**

**Naprawiono w plikach:**
1. `.claude/hooks/pre_compact_snapshot.py` (linia 89)
2. `.claude/hooks/post_autocompact_recovery.py` (linia 164)
3. `.claude/hooks/session_start_rules_reminder.py` (linia 193)

### Krok 6: Aktualizacja HookCreator skill

Zaktualizowano `C:\Users\kamil\.claude\skills\HookCreator\skill.md`:

**Zmiany:**
1. Poprawiono sekcjÄ™ "WHERE should hook live?" - `.claude/hooks/` jako standard
2. Dodano informacje o `$CLAUDE_PROJECT_DIR` environment variable
3. Wzmocniono sekcjÄ™ o stdin consumption (CRITICAL RULES)
4. UsuniÄ™to nieprawidÅ‚owe przykÅ‚ady z `_TOOLS/`

**PrzykÅ‚ad poprawnej lokalizacji:**
```markdown
**PROJECT HOOKS** (specific to one project):
- **Location:** `[project]/.claude/hooks/` (STANDARD - use this!)
- **Settings:** `[project]/.claude/settings.local.json`
- **Permission:** `Bash(python .claude/hooks/hook_name.py:*)`
```

### Krok 7: Cleanup

UsuniÄ™to stare pliki z `_TOOLS/`:
- ~~`_TOOLS/pre_compact_snapshot.py`~~
- ~~`_TOOLS/post_autocompact_recovery.py`~~
- ~~`_TOOLS/session_start_rules_reminder.py`~~

---

## ðŸ“‹ Checklist weryfikacji poprawnoÅ›ci hookÃ³w

KaÅ¼dy hook musi speÅ‚niaÄ‡:

### âœ… Struktura pliku
- [ ] Plik w `.claude/hooks/` (project) lub `~/.claude/hooks/` (global)
- [ ] Python script z `#!/usr/bin/env python3` shebang
- [ ] UTF-8 encoding (`# -*- coding: utf-8 -*-`)

### âœ… Kod hooka
- [ ] **MANDATORY:** `stdin_data = sys.stdin.read()` na poczÄ…tku main()
- [ ] Exit code 0 (success) lub 2 (blocking)
- [ ] Error handling (try/except)
- [ ] Graceful failure (nie crash przy bÅ‚Ä™dzie)

### âœ… Konfiguracja
- [ ] Hook zdefiniowany w `.claude/settings.local.json`
- [ ] Poprawny matcher dla hook type
- [ ] Permission dodany do `permissions.allow[]`
- [ ] Path relatywny (`.claude/hooks/`) lub z `$CLAUDE_PROJECT_DIR`

### âœ… Testing
- [ ] Manual test: `echo '{"session_id":"test"}' | python .claude/hooks/hook.py`
- [ ] Exit code check: `echo $?` (powinno byÄ‡ 0)
- [ ] Test bez stdin: `python .claude/hooks/hook.py < /dev/null` (nie powinno zawisnÄ…Ä‡)

---

## ðŸ”§ Template dla nowego hooka

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Hook Name: [Descriptive Name]
Hook Type: [PreToolUse/PostToolUse/SessionStart/etc.]
Purpose: [What this hook does and why]
"""

import sys
import json
import os
from pathlib import Path

# Fix Windows UTF-8 encoding for emoji
if sys.platform == "win32":
    sys.stdout.reconfigure(encoding='utf-8')
    sys.stderr.reconfigure(encoding='utf-8')

def main():
    """GÅ‚Ã³wna funkcja hooka"""
    try:
        # CRITICAL: Always consume stdin (Claude sends JSON session info)
        stdin_data = sys.stdin.read()

        # Parse if needed (optional)
        try:
            hook_input = json.loads(stdin_data) if stdin_data else {}
        except:
            hook_input = {}

        # Access hook data
        session_id = hook_input.get('session_id', 'unknown')
        cwd = hook_input.get('cwd', os.getcwd())
        hook_event = hook_input.get('hook_event_name', 'unknown')

        # ============================================
        # YOUR HOOK LOGIC HERE
        # ============================================

        print("Hook executed successfully!")

        # Return success
        return 0

    except Exception as e:
        # Graceful failure - display error but don't block
        print(f"Hook error: {e}", file=sys.stderr)
        return 1

if __name__ == "__main__":
    sys.exit(main())
```

---

## ðŸš€ Aktywacja naprawionych hookÃ³w

**WYMAGANY RESTART Claude Code!**

1. Zamknij Claude Code (caÅ‚kowicie)
2. OtwÃ³rz ponownie Claude Code
3. Hooki powinny teraz dziaÅ‚aÄ‡ poprawnie

**Weryfikacja:**
- PreCompact hook uruchomi siÄ™ przy compact (manual lub auto)
- SessionStart hooks uruchomiÄ… siÄ™ przy starcie sesji
- W transcript powinny byÄ‡ widoczne outputy hookÃ³w

---

## ðŸ“š Dokumentacja referencyjna

### Oficjalna dokumentacja Claude Code:
- [Hooks Reference](https://docs.claude.com/en/docs/claude-code/hooks)
- [Hooks Guide](https://docs.claude.com/en/docs/claude-code/hooks-guide.md)
- [Settings](https://docs.claude.com/en/docs/claude-code/settings.md)

### Lokalna dokumentacja:
- `C:\Users\kamil\.claude\skills\HookCreator\skill.md` - Zaktualizowany skill z peÅ‚nÄ… wiedzÄ…
- `_DOCS/GLOBAL_VS_PROJECT_PERMISSIONS.md` - Architektura permissions

### Hook types w PPM-CC-Laravel:
1. **PreCompact** (`pre_compact_snapshot.py`) - Zapisuje snapshot kontekstu przed compact
2. **SessionStart:compact** (`post_autocompact_recovery.py`) - Przywraca kontekst po autocompact
3. **SessionStart** (`session_start_rules_reminder.py`) - Przypomina o zasadach projektu

---

## ðŸŽ¯ Key Takeaways

### âŒ BÅ‚Ä™dy do unikania:
1. Umieszczanie hookÃ³w w niestandardowych lokalizacjach (np. `_TOOLS/`)
2. **Nie konsumowanie stdin** - powoduje deadlock!
3. Niepoprawne exit codes
4. Brak error handling

### âœ… Best practices:
1. UÅ¼ywaj `.claude/hooks/` dla project hooks (standard location)
2. **ZAWSZE** konsumuj stdin na poczÄ…tku: `stdin_data = sys.stdin.read()`
3. Exit z kodem 0 (success) lub 2 (blocking)
4. Graceful failure - nie crash przy bÅ‚Ä™dach
5. Test manual przed deployment

### ðŸ“ Standard lokalizacji:
```
GLOBAL HOOKS:  C:\Users\[user]\.claude\hooks\     (dla wszystkich projektÃ³w)
PROJECT HOOKS: [project]/.claude/hooks/            (tylko dla tego projektu)
```

---

**Last Updated:** 2025-10-31
**Status:** âœ… COMPLETE - Wszystkie hooki naprawione i przetestowane
**Next Steps:** Restart Claude Code i weryfikacja dziaÅ‚ania
